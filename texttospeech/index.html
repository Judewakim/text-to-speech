<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Text to Speech using AWS Polly!</title>
    <!-- Styling for the client UI -->
    <style>
    h1 {
        color: #FFFFFF;
        font-family: system-ui;
		margin-left: 20px;
        }
	body {
        background-color: #222629;
        }
    label {
        color: #86C232;
        font-family: system-ui;
        font-size: 20px;
        margin-left: 20px;
		margin-top: 20px;
        }
     button {
        background-color: #86C232;
		border-color: #86C232;
		color: #FFFFFF;
        font-family: system-ui;
        font-size: 20px;
		font-weight: bold;
        margin-left: 30px;
		margin-top: 20px;
		width: 140px;
        }
	 input {
        color: #222629;
        font-family: system-ui;
        font-size: 20px;
        margin-left: 10px;
		margin-top: 20px;
		width: 300px;
        }
    </style>
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1108.0.min.js"></script>
    <script>
        // Configure AWS SDK
        AWS.config.update({
            region: 'us-east-1',
            credentials: new AWS.Credentials('AKIAVV2XLYFN2YQYVDGA','TZDpfni1XCCAT2C6SBj9FqDCq6ULc04HlyHi+bTz') //NEVER HARDCODE. TEMPORARY ACCESS KEY, SECRET ACCESS KEY
        });

        const s3 = new AWS.S3();

        // Function to upload text as a file to S3
        function uploadTextToS3(entry) {
            const bucketName = 'bucketforfirstaiprojecttf'; // S3 bucket name where txt files are stored
            const key = `text_files/${Date.now()}.txt`; // Unique file name

            // Create a blob from the text input
            const blob = new Blob([entry], { type: 'text/plain' });

            const params = {
                Bucket: bucketName,
                Key: key,
                Body: blob,
                ContentType: 'text/plain'
            };

            // Upload the file to S3
            s3.upload(params, function(err, data) {
                if (err) {
                    console.error('Error uploading file:', err);
                    alert('Error uploading file: ' + JSON.stringify(err)); //show detailed error
                } else {
                    console.log('Uploaded file data:', JSON.stringify(data));
                    alert('Text file uploaded successfully!');

                    // Log data object to see what it returns
                    console.log('Uploaded file key:', data);

                    // Pass the correct key to check for the audio file
                    if (data && data.Key) {
                        checkForAudioFile(data.Key);
                    } else {
                        alert('Upload successful, but no Key found in the response.');
                        console.log('Complete response object:', data); // log the entire object to check for issues
                    }

                    // Call function to check for audio file
                    checkForAudioFile(data.Key);
                }
            });
        }

        // Function to check for the audio file
        function checkForAudioFile(textFileKey) {
            // Audio files are named like: audio_text_files/{timestamp}.txt.mp3
            const audioBucket = 'audiostoragebucketforfirstaiprojecttf';
            const audioFileKey = `audio_text_files/${textFileKey.split('/').pop().replace('.txt', '.mp3')}`;

            const params = {
                Bucket: audioBucket,
                Key: audioFileKey
            };

            // Try to get the audio file
            s3.getObject(params, function(err, data) {
                if (err) {
                    if (err.code === 'NoSuchKey') {
                        // If the audio file doesn't exist yet, check again after a short delay
                        setTimeout(() => checkForAudioFile(textFileKey), 5000); // Poll every 5 seconds
                    } else {
                        console.error('Error checking for audio file:', err);
                        alert('Error checking for audio file: ' + JSON.stringify(err));
                    }
                } else {
                    // If the file exists, show a download link
                    const audioFileUrl = `https://${audioBucket}.s3.amazonaws.com/${audioFileKey}`;
                    alert('Audio file is ready! Download it here: ' + audioFileUrl);
                }
            });
        }

        // Button click event handler
        function handleSubmit() {
            const entry = document.getElementById('entry').value;
            if (entry) {
                uploadTextToS3(entry);
            } else {
                alert('Please enter some text before submitting.');
            }
        }
    </script>
</head>
<body>
    <h1>Text to Speech using AWS Polly!</h1>
	<form>
        <label>What do you want to say?</label><br>
        <input type="text" id="entry" required><br>
        <button type="button" onclick="handleSubmit()">GENERATE AUDIO</button>
    </form>
</body>
</html>